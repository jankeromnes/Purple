<!DOCTYPE html>
<!--
// Purple Extension 
//  part of the Purple project
// Copyright 2011 Google Inc. 
// see Purple/license.txt for BSD license
// johnjbarton@google.com
// Modified form http://src.chromium.org/viewvc/chrome/trunk/src/chrome/common/extensions/docs/examples/extensions/imageinfo/background.html?content-type=text/plain
// on 31AUG11
-->
<html>
  <head>
  </head>
  <body>
    <script>
      function reportOnCreate(win) {
       console.log("reportOnCreate "+win.id);
      }
      function eatDogfood() {
        return localStorage.getItem('dogfood');
      }
      /* 
       * Returns a number or null
       */
      function insureNumber(n) {
         return isFinite(n) ? n : null;
      }
      /**
       * Returns a handler which will open a new window when activated.
       */
      function getClickHandler() {
        return function(info, tab) {
          var url = 'ppa.html';
          if (eatDogfood()) {
            url = url + '?dogfood';
          }
          url = url + '#' + tab.id;
          var createData = {url: url, type: 'popup' };

          var width = parseInt(window.localStorage.getItem('windowWidth'));
          createData.width = insureNumber(width) || (Math.floor(window.screen.availWidth / 2) - 2);

          var height = parseInt(window.localStorage.getItem('windowHeight'));
          createData.height = insureNumber(height) || window.screen.availHeight;

          var top = parseInt(window.localStorage.getItem('windowTop'));
          createData.top = insureNumber(top) || window.screen.availTop;

          var left = parseInt(window.localStorage.getItem('windowLeft'));
          createData.left = insureNumber(left) || (window.screen.availLeft + (window.screen.availWidth - createData.width) );
   console.log("chrome.windows.create:"+createData, createData);
          // Open Purple in a new window.
          chrome.windows.create(createData, reportOnCreate);
        };
      };

      /**
       * Create a context menu which will only show up on all pages
       */
      chrome.contextMenus.create({
        "title" : "Purple",
        "type" : "normal",
        "contexts" : ["page"],
        "onclick" : getClickHandler()
      });

//-------------------------------------------------------------------------------
// Page Actions

      var editParametersByURL = {};
      var tabIdByURL = {};

// Show option to Click to open site in Orion editor

      function checkForPageAction(url, tabId) {
        tabIdByURL[url] = tabId;

        var editableURLs = Object.keys(editParametersByURL);
        editableURLs.forEach(function(url) {
           var tabId = tabIdByURL[url];
           if(tabId) {
             chrome.pageAction.show(tabId);
           }
        });
      }

      function reportListeners(where, like) {
        console.log(where+" has:"+chrome.webNavigation.onBeforeNavigate.hasListener(like)+" total: "+
         chrome.webNavigation.onBeforeNavigate.listeners_.length);
      }

      function checkForEditHeader(details) {

        var url = details.url;
        var tabId = details.tabId;

        delete editParametersByURL[details.url];

        var editParams = {};
        var headers = details.responseHeaders;
        headers.forEach(function findOrion(header) {
          if (header.name === "X-Edit-Server") {
            editParams.server = header.value;
          } else if (header.name === "X-Edit-Token") {
            editParams.token = header.value;
          }
       });
        if (editParams.server) {
          editParametersByURL[details.url] = editParams;
        }
        checkForPageAction(url, tabId);
      }
  

      chrome.experimental.webRequest.onCompleted.addListener(checkForEditHeader, {types:['main_frame']}, ['responseHeaders']);

//--------------------------------------------------------------------------
// Add Page Action onUpdated tab

      function onTabUpdated(tabId, changeInfo, tab) {
        checkForPageAction(tab.url, tab.id);
      }

      chrome.tabs.onUpdated.addListener(onTabUpdated);

//-----------------------------------------------------------------------------
// Open editor on page action click

      function launchEditAction(tab) {
        var editParameters = editParametersByURL[tab.url];
        if (editParameters) {
          var url = editParameters.server + editParameters.token;
          chrome.tabs.create({url: url});
        }
      }
      chrome.pageAction.onClicked.addListener(launchEditAction);

//------------------------------------------------------------------------------
// SuperLogin: reload all Orion pages after logging in.

  var debugSuperLogin = false;

  chrome.extension.onRequest.addListener(
    function superLogin(request, sender, sendResponse) {
      if (debugSuperLogin) console.log(sender.tab ?
                  "from a content script:" + sender.tab.url :
                  "from the extension");
      if (request.orion == "loginUnloading") {
        sendResponse({farewell: "goodbye"});
        var host = sender.tab.url.split('/').slice(0,3).join('/');
        var tabs = [];
        chrome.windows.getAll({populate: true}, function(wins) {
          wins.forEach(function(win) {
            win.tabs.forEach(function(tab) {
              if (tab.url.indexOf(host) === 0 && tab.id !== sender.tab.id) {
                tabs.push(tab);
              }
            });
          });
          msg = "Reload "+tabs.length+" Orion pages?";
          if (window.confirm(msg)) {
            if (debugSuperLogin) console.log("need to reload ", tabs);
            tabs.forEach(function(tab) {
              chrome.tabs.reload(tab.id, {}, function() {
                if (chrome.extension.lastError) {
                  console.error("Reload failed for "+tab.url+" "+chrome.extension.lastError);
                } else {
                  if (debugSuperLogin) console.log("Reloaded "+tab.url);
                }
              });
            });
          }
        });
      } else {
        sendResponse({}); // snub them.
      }
    }
  );
    </script>
  </body>
</html>
