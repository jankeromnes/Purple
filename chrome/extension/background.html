<!DOCTYPE html>
<!--
// Purple Extension 
//  part of the Purple project
// Copyright 2011 Google Inc. 
// see Purple/license.txt for BSD license
// johnjbarton@google.com
// Modified form http://src.chromium.org/viewvc/chrome/trunk/src/chrome/common/extensions/docs/examples/extensions/imageinfo/background.html?content-type=text/plain
// on 31AUG11
-->
<html>
  <head>
  </head>
  <body>
    <script>
      function reportOnCreate(win) {
       console.log("reportOnCreate "+win.id);
      }
      function eatDogfood() {
        return localStorage.getItem('dogfood');
      }
      /* 
       * Returns a number or null
       */
      function insureNumber(n) {
         return isFinite(n) ? n : null;
      }
      /**
       * Returns a handler which will open a new window when activated.
       */
      function getClickHandler() {
        return function(info, tab) {
          var url = 'ppa.html';
          if (eatDogfood()) {
            url = url + '?dogfood';
          }
          url = url + '#' + tab.id;
          var createData = {url: url, type: 'popup' };

          var width = parseInt(window.localStorage.getItem('windowWidth'));
          createData.width = insureNumber(width) || (Math.floor(window.screen.availWidth / 2) - 2);

          var height = parseInt(window.localStorage.getItem('windowHeight'));
          createData.height = insureNumber(height) || window.screen.availHeight;

          var top = parseInt(window.localStorage.getItem('windowTop'));
          createData.top = insureNumber(top) || window.screen.availTop;

          var left = parseInt(window.localStorage.getItem('windowLeft'));
          createData.left = insureNumber(left) || (window.screen.availLeft + (window.screen.availWidth - createData.width) );
   console.log("chrome.windows.create:"+createData, createData);
          // Open Purple in a new window.
          chrome.windows.create(createData, reportOnCreate);
        };
      };

      /**
       * Create a context menu which will only show up on all pages
       */
      chrome.contextMenus.create({
        "title" : "Purple",
        "type" : "normal",
        "contexts" : ["page"],
        "onclick" : getClickHandler()
      });

      var editParametersByURL = {};
      var tabIdByURL = {};

      function checkForPageAction() {
        var editableURLs = Object.keys(editParametersByURL);
        editableURLs.forEach(function(url) {
           var tabId = tabIdByURL[url];
           if(tabId) {
             chrome.pageAction.show(tabId);
           }
        });
      }

      function checkForEditHeader(details) {
        delete editParametersByURL[details.url];

        var editParams = {};
        var headers = details.responseHeaders;
        headers.forEach(function findOrion(header) {
          if (header.name === "X-Edit-Server") {
            editParams.server = header.value;
          } else if (header.name === "X-Edit-Token") {
            editParams.token = header.value;
          }
        });
        if (editParams.server) {
          editParametersByURL[details.url] = editParams;
        }
        checkForPageAction();
      }
  

      chrome.experimental.webRequest.onCompleted.addListener(checkForEditHeader, {types:['main_frame']}, ['responseHeaders']);

      function onTabUpdated(tabId, changeInfo, tab) {
        tabIdByURL[tab.url] = tab.id;
        checkForPageAction();
      }

      chrome.tabs.onUpdated.addListener(onTabUpdated);

      function launchEditAction(tab) {
        var editParameters = editParametersByURL[tab.url];
        if (editParameters) {
          var url = editParameters.server + editParameters.token;
          chrome.tabs.create({url: url});
        }
      }
      chrome.pageAction.onClicked.addListener(launchEditAction);
    </script>
  </body>
</html>
