<!DOCTYPE html>
<!--

// Copyright 2011 Google Inc.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

-->
<html>
<head>
<title>Purple: parse, re-run, break loop experiment</title>
<script src="traceur/trunk/src/traceur.js"></script>
<style>
body {
  background-color: #6B3FA0;
}  
.editor {
  display: block;
  font-family: monospace;
  width: 80%;
  height: 300px;
}

.error {
  color: red;
}

</style>
<!-- From Orion embeddededitor -->
		<meta name="copyright" content="Copyright (c) IBM Corporation and others 2010." >
		<meta http-equiv="Content-Language" content="en-us">
		<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
    	<title>Embedded Orion Editor</title>
    	<link rel="stylesheet" type="text/css" href="orion.client/bundles/org.eclipse.orion.client.editor/web/examples/editor/embeddededitor.css" />
		
		<script type="text/javascript">
			var djConfig = {
				isDebug:false,
				parseOnLoad:true
			};
		</script>
		<script>
			// temporary
	    	var __originalDefine = window.define;
	    </script>
	    <script type="text/javascript" src="/org.dojotoolkit/dojo/dojo.js.uncompressed.js"></script>
		<script>
			// temporary
	    	window.define = __originalDefine;
	    </script>
	
		<!-- Web Editor -->
		<script src="orion.client/bundles/org.eclipse.orion.client.editor/web/orion/textview/keyBinding.js"></script>
		<script src="orion.client/bundles/org.eclipse.orion.client.editor/web/orion/textview/textModel.js"></script>
		<script src="orion.client/bundles/org.eclipse.orion.client.editor/web/orion/textview/textView.js"></script>
		<script src="orion.client/bundles/org.eclipse.orion.client.editor/web/orion/textview/rulers.js"></script>
		<script src="orion.client/bundles/org.eclipse.orion.client.editor/web/orion/textview/undoStack.js"></script>
		<script src="orion.client/bundles/org.eclipse.orion.client.editor/web/examples/textview/textStyler.js"></script>
	 	<script src="orion.client/bundles/org.eclipse.orion.client.editor/web/orion/editor/editorFeatures.js"></script>
	 	<script src="orion.client/bundles/org.eclipse.orion.client.editor/web/orion/editor/contentAssist.js"></script>
	 	<script src="orion.client/bundles/org.eclipse.orion.client.editor/web/orion/editor/htmlGrammar.js"></script>
	 	<script src="orion.client/bundles/org.eclipse.orion.client.editor/web/orion/editor/textMateStyler.js"></script>
	 	<script src="orion.client/bundles/org.eclipse.orion.client.editor/web/orion/editor/webContentAssist.js"></script>
	 	<script src="orion.client/bundles/org.eclipse.orion.client.editor/web/orion/editor/editor.js"></script>
<!-- End from Orion embeddededitor -->
<!-- Purple-integration -->
        <script type="text/javascript" src="ui/editorIntegration.js"></script>
        <script type="text/javascript" src="ui/embeddededitor.js"></script>

</head>
<body>
<pre class="error"></pre>
<label><input class="eval" type="checkbox" checked> Evaluate</label>
<pre class="eval"></pre>
<label><input class="output" type="checkbox" checked> Show generated code</label>
<pre class="output"></pre>
<!-- From Orion embeddededitor -->
    <div class="input" id="editor" style="width: 100%; height: 90%"></div>
	<div id="contentassist" class="contentassist"></div>
<!-- End embeddededitor -->
	<div id="poweredBy" style="height: 28px;text-align:center">
	    <a href="http://www.eclipse.org/orion/">
		<img src="orion.client/bundles/org.eclipse.orion.client.editor/web/examples/editor/images/skinnyheaderlogo.png" alt="Orion">
		Powered by Orion</a>
		and 
		<a href="http://code.google.com/p/traceur-compiler/">
		Traceur</a>		
	</div>


<script>

(function() {
  'use strict';

  var hasError = false;
  var input = document.querySelector('.input');
  var outputCheckbox = document.querySelector('input.output');
  var output = document.querySelector('pre.output');
  var evalCheckbox = document.querySelector('input.eval');
  var evalElement = document.querySelector('pre.eval');
  var errorElement = document.querySelector('pre.error');

  evalCheckbox.addEventListener('click', function(e) {
    evalElement.hidden = !evalCheckbox.checked;
  }, false);


  outputCheckbox.addEventListener('click', function(e) {
    output.hidden = !outputCheckbox.checked;
  }, false);

  function compile(name, src) {
    hasError = false;
    output.textContent = errorElement.textContent = '';

    var errorTypes = {
      "%s is not defined": function(format, args, message) {
      	return {token: '?', tooltip: message};
      },
    };
    var reporter = new traceur.util.ErrorReporter();
    reporter.reportMessageInternal = function(location, kind, format, args) {
      var i = 0;
      var message = format.replace(/%s/g, function() {
        return args[i++];
      });
      
      var getIndicator = errorTypes[format];
      if (getIndicator) {
        var indicator = getIndicator(format, args, message);
      } else {
        if (location) format = location + ': ' + message;
        errorElement.textContent += format + '\n';
        var indicator = {tooltop: message};
     }
	      
      window.purple.editorIntegration.reportError(indicator, location);
    };

    var project = new traceur.semantics.symbols.Project();
    var contents = src;
    var sourceFile = new traceur.syntax.SourceFile(name, contents);
    project.addFile(sourceFile);
    var res = traceur.codegeneration.Compiler.compile(reporter, project, false);
    if (reporter.hadError()) {
      hasError = true;
    } else {
      var source = output.textContent =
          traceur.codegeneration.ProjectWriter.write(res);

      if (evalCheckbox.checked) {
        try {
          evalElement.textContent = ('global', eval)(source);
        } catch(ex) {
          hasError = true;
          errorElement.textContent = ex;
          console.error(ex);
        }
      }
    }

    errorElement.hidden = !hasError;
  }

  window.purple.editorIntegration.onSourceChange = function(name, src, startDamage, endDamage) {
    if (src) compile(name, src);
  }
})();

</script>
</body>
</html>
