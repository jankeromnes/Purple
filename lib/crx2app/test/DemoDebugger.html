<html>
<head>
<title>crx2app: DemoDebugger test plugin</title>
<script src="../extension/appEnd/proxyChromePipe.js"></script>
<script src="../extension/lib/q/q.js"></script>
<script src="../extension/lib/requirejs/require.js"></script>
<script>

/*globals getChromeExtensionPipe window console Q require */

// We are a plugin in Orion, we have an internal chromeIframe talking to chrome.

var iframeDomain ="chrome-extension://bbjpappmojnmallpnfgfkjmjnhhplgog";

var connection = getChromeExtensionPipe(iframeDomain);

// dynamic iframe load
//
function loadPlugin(url) {
  var iframe = document.createElement('iframe');
  iframe.setAttribute('src', url);
  var elt = document.getElementById('loadChromeIframe');
  elt.appendChild(iframe);
}

var tests = {
  newTabCreated: Q.defer()
};

var tester = {
  eventHandlers: {
    tabs: {
      onCreated: function(tab) {
        if (tab.url === 'chrome://newtab/') {
          tests.newTabCreated.resolve(true);
        }
      },
      onUpdated: function(tab) {
      }
    },
    windows: {
      onCreated: function(window) {
      }
    }
  }
};

function testConnection(debuggerProxy, chromeProxy) {
    console.log("testing DemoDebugger");
    // TODO some testing
    var promise = tests.newTabCreated.promise;
    Q.when(promise, function(promise) {
    
      debuggerProxy._detach(chromeProxy);
    }).end();
}
function failConnection(err) {
    console.err("Error "+err, err);
}

function onMessage(event) {

  // Mock Orion (outer window) calls us
  if (event.data === 'go') {
  
    // dynamically load the debugger code
    require({
      paths: {
        "crx2app": "../extension",
        "browser/remote": "extension/rpc"
      }
    }); 

   require.onError = function(err) {
     console.error(err+"", {stack: err.stack.split('\n')});
   };

   require(['DemoDebugger', 'crx2app/rpc/ChromeProxy'], function testIt(DemoDebugger, ChromeProxy) {
   
     // wrap the connection in rpc stuff for chrome.* api
     var chromeProxy = ChromeProxy.new(connection, tester.eventHandlers);
     
     // wrap the connection in more rpc stuff for remote debug protocol through chrome.debugger,
     // and attach to a new tab, enable debugging and update the page to the given URL.
     var testURL = window.location.toString();
     var debuggerProxy = chromeProxy.openDebuggerProxy(testURL, DemoDebugger.eventHandlers);
     
     // when we are attached to the given page, test it.
     Q.when(debuggerProxy, function(debuggerProxy) {
       testConnection(debuggerProxy, chromeProxy);
     }, failConnection).end();
   });
  }
}

function attach(event) {

  // listen for a connection.
  connection.attach(function onConnectedToChrome() {
  
    // we have connected to the extension, so plugin to Orion.
      
    // listen for fake-Orion to tell us to do something
    window.addEventListener('message', onMessage, false);

    // The test driver just responds 'go' for our 'Ready' 
    window.parent.postMessage("DemoDebugger", "*");
    
    console.log("Plugin Ready "+window.location+" posted "+"DemoDebugger");
  });
  
  // dynamically load the chromeIframe, it will connect and fire the callback
  // (if we load the iframe statically, 
  // this outer load event will come *after* the iframe load event.)
  loadPlugin(iframeDomain + "/appEnd/chromeIframe.html");
}

function onLoad() {
  // clean up
  window.removeEventListener('load', onLoad, false);
  
  // connect to the chromeIframe
  attach();
}

// as soon as we load, setup the test
//
window.addEventListener('load', onLoad, false);

function detach() {
  connection.detach();
}

window.addEventListener('unload', detach, false);

</script>
</head>
<body>
<h1>DemoDebugger test plugin</h1>
<div id="loadChromeIframe">
</div>
</body>
</html>